<!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <title>CSS selector test</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
    }

    html {
      margin: 2rem auto 2rem auto;
      max-width: 45rem;
    }

    #html-rendered {
      margin-top: 1rem;
      margin-bottom: 1rem;
      background-color: hsl(0 0 90%);
      padding: 0.25rem 1rem 0.25rem 1rem;
      border-radius: 0.5rem;
    }

    textarea {
      font-family: monospace;
    }

    #examples {
      margin-top: -0.5rem;
      display: flex;
      flex-direction: row;
      gap: 0.75rem;
      font-size: small;

      a {
        font-family: monospace;
      }
    }

    #error-message {
      color: red;
      font-weight: bold;
    }
  </style>
  <style id="computed-style"></style>
</head>
<body>
  <h1>CSS selector test</h1>
  <div>
    <textarea id="html-source" cols="80" rows="20"></textarea>
  </div>
  <div>
    <a href="" id="render-html">Render below</a>
    &nbsp;|&nbsp;
    <a href="" id="save-input">Save to URL</a>
    &nbsp;|&nbsp;
    <a href="" id="reset-input">Reset</a>
  </div>
  <div id="html-rendered"></div>
  <hr>
  <p>
    <label>
      CSS selector:
      <input type="text" id="css-selector">
    </label>
  </p>
  <div id="examples">
    Examples:
    <a href="">p</a>
    <a href="">li</a>
    <a href="">.first</a>
    <a href="">#navigation</a>
    <a href="">*</a>
    <a href="">li.first</a>
  </div>
  <p id="error-message"></p>
  <pre id="selected-tags"></pre>

  <template id="default-html-template">
    <p class="first">Web development resources:</p>
    <ul class="resources first">
      <li class="first">JavaScript: <a href="https://exploringjs.com/js/">“Exploring JavaScript”</a></li>
      <li>HTML, CSS, JavaScript: <a href="https://developer.mozilla.org/en-US/">“MDN Web Docs”</a></li>
      <li>Search the web for more resources!</li>
    </ul>

    <nav id="navigation">
      <p>Navigation:</p>
      <ul>
        <li class="first"><a href="https://2ality.com/2025/08/learning-web-dev-toc.html">TOC</a></li>
        <li><a href="https://github.com/rauschma/learning-web-dev-code/">Repo</a></li>
      </ul>
    </nav>
  </template>
  
  <script type="module">
    const selectorPrefix = '#html-rendered ';
    const defaultHtmlTemplate = document.querySelector('#default-html-template');
    const defaultHtml = dedentTemplateHtml(
      documentFragmentToHtml(defaultHtmlTemplate.content)
    );
    restoreInputFromUrl();

    document.querySelector('#render-html').addEventListener(
      'click',
      (event) => {
        event.preventDefault();
        renderHtml();
      }
    );
    document.querySelector('#reset-input').addEventListener(
      'click',
      (event) => {
        event.preventDefault();
        resetUrlAndInput();
      }
    );
    document.querySelector('#save-input').addEventListener(
      'click',
      (event) => {
        event.preventDefault();
        saveInputToUrl();
      }
    );
    document.querySelector('#css-selector').addEventListener(
      'change',
      (event) => {
        displaySelector();
      }
    );
    for (const link of document.querySelectorAll('#examples a')) {
      link.addEventListener(
        'click',
        (event) => {
          event.preventDefault();
          document.querySelector('#css-selector').value = event.target.innerText;
          displaySelector();
        }
      );
    }

    //========== Selector ==========

    function displaySelector() {
      const userSelector = document.querySelector('#css-selector').value.trim();
      let css = '';
      let tags = [];
      let errorMessage = '';
      if (userSelector.length > 0) {
        // Make sure the selector only matches inside the rendered HTML (as
        // provided by the user)
        const internalSelector = userSelector
          .split(/\s*,\s*/)
          .map(sel => selectorPrefix + sel)
          .join(', ')
          ;
        css = `
          ${internalSelector} {
            background-color: yellow;
          }
        `;
        try {
          tags = getTagsForSelector(internalSelector);
        } catch (err) {
          css = '';
          tags = [];
          errorMessage = String(err).replaceAll(selectorPrefix, '');
        }
      }
      document.querySelector('#computed-style').innerHTML = css;
      document.querySelector('#selected-tags').innerText = tags.join('\n');
      document.querySelector('#error-message').innerText = errorMessage;
    }

    function getTagsForSelector(selector) {
      return Array.from(
        document.querySelectorAll(selector),
        (el) => {
          const html = el.outerHTML;
          const gtIndex = html.indexOf('>');
          return html.slice(0, gtIndex + 1);
        }
      );
    }

    //========== Save and restore to/from URL ==========

    function saveInputToUrl() {
      const newLocation = new URL(location);
      newLocation.search = '';
      const selector = document.querySelector('#css-selector').value;
      newLocation.searchParams.set('selector', selector);
      const html = document.querySelector('#html-source').value;
      if (html !== defaultHtml) {
        newLocation.searchParams.set('html', html);
      }
      history.pushState({}, '', newLocation);
    }

    function resetUrlAndInput() {
      document.querySelector('#html-source').value = defaultHtml;
      document.querySelector('#css-selector').value = '';
      const newLocation = new URL(location);
      newLocation.search = '';
      history.pushState({}, '', newLocation);
      renderHtml();
      displaySelector();
    }

    function restoreInputFromUrl() {
      const params = new URL(location).searchParams;

      const html = params.get('html') ?? defaultHtml;
      document.querySelector('#html-source').value = html;

      const selector = params.get('selector') ?? '';
      document.querySelector('#css-selector').value = selector;

      renderHtml();
      displaySelector();
    }

    //========== HTML ==========

    function renderHtml() {
      const html = document.querySelector('#html-source').value;
      document.querySelector('#html-rendered').innerHTML = html;
    }

    //========== Helper functions ==========

    function documentFragmentToHtml(fragment) {
      const div = document.createElement('div');
      div.appendChild(fragment.cloneNode(true));
      return div.innerHTML;
    }

    function escapeHtml(plainText) {
      return plainText
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll(`'`, '&apos;')
        ;
    }

    function dedentTemplateHtml(text) {
      // Starts with a line break!
      const prefixMatch = /^(\r?\n)[ \t]*/v.exec(text);
      if (prefixMatch === null) {
        return text;
      }
      const [prefix, lineBreak] = prefixMatch;
      return text.trim().replaceAll(prefix, lineBreak);
    }
  </script>
</body>
</html>